<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth State Machine Description</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 20px;
        }
        h1, h2, h3 {
            color: #333;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .state {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .event {
            font-weight: bold;
        }
        .note {
            font-style: italic;
            color: #555;
            font-size: 0.9em;
        }
        .action {
            color: #d35400;
            font-style: italic;
        }
    </style>
</head>
<body>

    <h1>Auth State Machine Description</h1>

    <p>This document describes the state machine responsible for handling authentication logic in the application. It is built using XState.</p>

    <h2>States</h2>

    <div class="state">
        <h3><code>checkingSession</code></h3>
        <p>The initial state. It checks if a user session exists.</p>
        <ul>
            <li>On success (session found), it transitions to <code>authorized</code>.</li>
            <li>On failure (no session), it transitions to <code>unauthorized</code>.</li>
        </ul>
    </div>

    <div class="state">
        <h3><code>unauthorized</code></h3>
        <p>The parent state for all unauthenticated user flows.</p>
        <h4>Child States:</h4>
        <ul>
            <li><strong><code>login</code></strong>: The default state for logging in.
                <ul>
                    <li><code>idle</code>: Waiting for user input.</li>
                    <li><code>submitting</code>: Sending login credentials to the server.</li>
                </ul>
                <p class="note">On submission failure (e.g., invalid credentials), the machine returns to the <code>idle</code> state and an error message is populated in the context for the UI to display.</p>
            </li>
            <li><strong><code>register</code></strong>: Handles user registration with OTP verification.
                <ul>
                    <li><code>form</code>: Initial form state waiting for user input.</li>
                    <li><code>submitting</code>: Sending registration details to the server.</li>
                    <li><code>verifyOtp</code>: Waiting for user to enter OTP.</li>
                    <li><code>verifyingOtp</code>: Sending OTP to server for verification.</li>
                    <li><code>completingRegistration</code>: Completing registration with new password.</li>
                    <li><code>loggingIn</code>: Logging in the newly registered user.</li>
                </ul>
                <p class="note">On submission failure (e.g., email already exists), the machine returns to the <code>form</code> state with an error message.</p>
            </li>
            <li><strong><code>forgotPassword</code></strong>: Manages the password reset flow.
                <ul>
                    <li><code>idle</code>: Waiting for the user to enter their email.</li>
                    <li><code>submitting</code>: Requesting an OTP from the server.</li>
                    <li><code>verifyOtp</code>: Waiting for the user to enter the OTP.</li>
                    <li><code>verifyingOtp</code>: Sending the OTP to the server for verification.</li>
                    <li><code>resetPassword</code>: Waiting for the user to enter the new password.</li>
                    <li><code>resettingPassword</code>: Sending the new password to the server.</li>
                    <li><code>loggingInAfterReset</code>: Logging in after password reset.</li>
                </ul>
                 <p class="note">On failure at any step (e.g., email not found, invalid OTP), the machine returns to the state for that step (e.g., <code>idle</code> or <code>verifyOtp</code>) and populates an error message in the context.</p>
            </li>
        </ul>
    </div>

    <div class="state">
        <h3><code>authorized</code></h3>
        <p>The user is authenticated and has a valid session. The available event is <code>LOGOUT</code>.</p>
    </div>

    <div class="state">
        <h3><code>loggingOut</code></h3>
        <p>This state is responsible for clearing the user session and transitioning back to the <code>unauthorized</code> state.</p>
    </div>

    <h2>Events</h2>
    <ul>
        <li><code class="event">CHECK_SESSION</code>: Triggered on machine start to check for an existing session.</li>
        <li><code class="event">LOGIN</code>: Dispatched with email and password to log in.</li>
        <li><code class="event">REGISTER</code>: Dispatched with user details to create an account.</li>
        <li><code class="event">FORGOT_PASSWORD</code>: Dispatched with an email to initiate password reset.</li>
        <li><code class="event">VERIFY_OTP</code>: Dispatched with an OTP to verify the user's identity.</li>
        <li><code class="event">RESET_PASSWORD</code>: Dispatched with a new password to finalize the reset.</li>
        <li><code class="event">LOGOUT</code>: Dispatched to log the user out.</li>
        <li><code class="event">CANCEL</code>: Dispatched to cancel an in-progress operation.</li>
        <li><code class="event">GO_TO_REGISTER</code>: Navigates to the registration form.</li>
        <li><code class="event">GO_TO_LOGIN</code>: Navigates to the login form.</li>
        <li><code class="event">GO_TO_FORGOT_PASSWORD</code>: Navigates to the forgot password form.</li>
    </ul>

    <h2>Actions</h2>
    <ul>
        <li><code class="action">setSession</code>: Assigns the session data and clears any error.</li>
        <li><code class="action">setError</code>: Sets an error message in the context.</li>
        <li><code class="action">clearError</code>: Clears the error from the context.</li>
        <li><code class="action">clearSession</code>: Clears the session data.</li>
        <li><code class="action">setEmailFromPayload</code>: Sets the email from the event payload.</li>
        <li><code class="action">clearForgotPasswordContext</code>: Clears email, reset action token, and pending credentials.</li>
        <li><code class="action">clearRegistrationContext</code>: Clears email, registration action token, and pending credentials.</li>
        <li><code class="action">setPendingCredentials</code>: Sets pending credentials from the event payload.</li>
        <li><code class="action">clearPendingCredentials</code>: Clears pending credentials from the context.</li>
        <li><code class="action">setRegistrationActionToken</code>: Sets the registration action token from output.</li>
        <li><code class="action">setResetActionToken</code>: Sets the reset action token from output.</li>
        <li><code class="action">setPendingCredentialsFromNewPassword</code>: Sets pending credentials with new password.</li>
    </ul>

</body>
</html>