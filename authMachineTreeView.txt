Auth State Machine Tree View:

- checkingSession
  - invoke: checkSessionParams
  - onDone:
    - (guard: session exists) -> authorized
    - (no session) -> unauthorized
  - onError: -> unauthorized

- unauthorized
  - initial: login
  - states:
    - login
      - initial: idle
      - on:
        - GO_TO_REGISTER: -> register
        - GO_TO_FORGOT_PASSWORD: -> forgotPassword
      - states:
        - idle
          - on: LOGIN -> submitting
        - submitting
          - on: CANCEL -> idle
          - invoke: loginUser
          - onDone: -> #auth.authorized (actions: setSession, clearPendingCredentials)
          - onError: -> idle (actions: setError)
    - register
      - initial: form
      - on:
        - GO_TO_LOGIN: -> login (actions: clearRegistrationContext, clearError)
      - states:
        - form
          - on: REGISTER -> submitting (actions: clearError, setPendingCredentials, setEmailFromPayload)
        - submitting
          - on: CANCEL -> form (actions: clearRegistrationContext)
          - invoke: registerUser
          - onDone: -> verifyOtp
          - onError: -> form (actions: setError)
        - verifyOtp
          - on:
            - VERIFY_OTP: -> verifyingOtp (guard: email exists)
            - CANCEL: -> form (actions: clearRegistrationContext)
        - verifyingOtp
          - invoke: verifyOtp
          - onDone: -> completingRegistration (actions: setRegistrationActionToken)
          - onError: -> verifyOtp (actions: setError)
        - completingRegistration
          - invoke: completeRegistration
          - onDone: -> loggingIn
          - onError: -> verifyOtp (actions: setError)
        - loggingIn
          - invoke: loginUser
          - onDone: -> #auth.authorized (actions: setSession, clearRegistrationContext, clearPendingCredentials)
          - onError: -> #auth.unauthorized.login (actions: setError, clearRegistrationContext, clearPendingCredentials)
    - forgotPassword
      - initial: idle
      - on:
        - GO_TO_LOGIN: -> login (actions: clearForgotPasswordContext, clearError)
      - states:
        - idle
          - on: FORGOT_PASSWORD -> submitting (actions: setEmailFromPayload, clearError)
        - submitting
          - on: CANCEL -> idle
          - invoke: requestPasswordReset
          - onDone: -> verifyOtp
          - onError: -> idle (actions: setError)
        - verifyOtp
          - on:
            - VERIFY_OTP: -> verifyingOtp (guard: email exists)
            - CANCEL: -> idle (actions: clearForgotPasswordContext)
        - verifyingOtp
          - invoke: verifyOtp
          - onDone: -> resetPassword (actions: setResetActionToken)
          - onError: -> verifyOtp (actions: setError)
        - resetPassword
          - on:
            - RESET_PASSWORD: -> resettingPassword (guard: action token exists, actions: setPendingCredentialsFromNewPassword)
        - resettingPassword
          - invoke: completePasswordReset
          - onDone: -> loggingInAfterReset
          - onError: -> resetPassword (actions: setError)
        - loggingInAfterReset
          - invoke: loginUser
          - onDone: -> #auth.authorized (actions: setSession, clearForgotPasswordContext, clearPendingCredentials)
          - onError: -> #auth.unauthorized.login (actions: setError, clearForgotPasswordContext, clearPendingCredentials)

- authorized
  - on:
    - LOGOUT: -> loggingOut

- loggingOut
  - invoke: logoutUser
  - onDone: -> unauthorized (actions: clearSession, clearError)
  - onError: -> authorized (actions: setError)